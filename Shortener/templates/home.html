<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>URL Shortener</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    input, button { padding: 0.5rem; margin: 0.5rem 0; width: 300px; }
    .section { margin-bottom: 2rem; }
    pre { background: #f4f4f4; padding: 1rem; max-width: 600px; overflow-x: auto; }
    #createResult a { margin-right: 1rem; }
  </style>
</head>
<body>
  <h1>Simple URL Shortener</h1>

  <div class="section">
    <h2>Create Short Link</h2>
    <input type="text" id="inputUrl" placeholder="Enter a long URL" />
    <input type="text" id="inputCustom" placeholder="Optional custom code" />
    <button onclick="createShortLink()">Shorten</button>
    <div id="createResult"></div>
  </div>

  <div class="section">
    <h2>Get Analytics</h2>
    <input type="text" id="inputShortCode" placeholder="Enter short code" />
    <button onclick="getAnalytics()">Get Analytics</button>
    <div id="analyticsResult"></div>
  </div>

  <script>
    const apiBase = 'http://localhost:8080';

    async function fetchWithErrorHandling(url, options) {
      const response = await fetch(url, options);
      if (!response.ok) {
        const text = await response.text();
        throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
      }
      return await response.json();
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert("Copied to clipboard!");
      }).catch(err => {
        alert("Failed to copy: " + err);
      });
    }

    async function createShortLink() {
      const url = document.getElementById('inputUrl').value.trim();
      const custom = document.getElementById('inputCustom').value.trim();

      if (!url) {
        alert('Please enter a URL');
        return;
      }

      const payload = { url };
      if (custom) payload.short_code = custom;

      try {
        const data = await fetchWithErrorHandling(`${apiBase}/shorten`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        document.getElementById('createResult').innerHTML =
          `<a href="${data.short_url}" target="_blank">${data.short_url}</a>
          <button onclick='copyToClipboard("${data.short_url}")'>Copy</button>`;
      } catch (e) {
        document.getElementById('createResult').textContent = 'Request failed: ' + e.message;
      }
    }

   async function getAnalytics() {
  let shortCode = document.getElementById('inputShortCode').value.trim();
  if (!shortCode) {
    alert('Please enter a short code or full URL');
    return;
  }

  // Если введён полный URL с /s/, извлечь короткий код
  try {
    const urlObj = new URL(shortCode);
    const pathSegments = urlObj.pathname.split('/');
    // ожидаем, что короткий код во втором сегменте "/s/:shortCode"
    if (pathSegments.length >= 3 && pathSegments[1] === 's') {
      shortCode = pathSegments[2];
    } else {
      alert('Invalid URL format for analytics');
      return;
    }
  } catch {
    // Если не URL, оставляем как есть (короткий код)
  }

  if (!shortCode) {
    alert('Cannot extract short code from input');
    return;
  }

  try {
    const data = await fetchWithErrorHandling(`${apiBase}/analytics/${shortCode}`);
    const pretty = JSON.stringify(data, null, 2);
    document.getElementById('analyticsResult').innerHTML = `<pre>${pretty}</pre>`;
  } catch (e) {
    document.getElementById('analyticsResult').textContent = 'Request failed: ' + e.message;
  }
}

  </script>
</body>
</html>
