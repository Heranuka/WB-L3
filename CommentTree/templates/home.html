<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Comments with Search and Pagination</title>
<style>
  /* Ваши стили, сохраните как есть или добавьте по необходимости */
</style>
</head>
<body>

<h1>Comments</h1>

<div class="search-container">
  <input type="text" id="searchBox" placeholder="Search comments..." />
  <button id="searchBtn">Найти</button>
</div>
<div id="errorMessage"></div>

<ul id="commentsList"></ul>

<div id="paginationControls">
  <button id="prevPageBtn" disabled>Previous</button>
  <button id="nextPageBtn" disabled>Next</button>
</div>

<hr>

<form id="newCommentForm">
  <h2>Add a new comment</h2>
  <input type="hidden" id="replyParentId" />
  <textarea id="content" rows="4" placeholder="Write your comment here" required style="width: 100%;"></textarea>
  <br />
  <button type="submit">Submit Comment</button>
  <button type="button" id="cancelReplyBtn" style="display:none;">Cancel Reply</button>
</form>

<script>
const commentsList = document.getElementById('commentsList');
const form = document.getElementById('newCommentForm');
const contentField = document.getElementById('content');
const replyParentIdField = document.getElementById('replyParentId');
const cancelReplyBtn = document.getElementById('cancelReplyBtn');
const searchBox = document.getElementById('searchBox');
const searchBtn = document.getElementById('searchBtn');
const errorMessage = document.getElementById('errorMessage');
const prevPageBtn = document.getElementById('prevPageBtn');
const nextPageBtn = document.getElementById('nextPageBtn');

let loadedComments = [];
let currentPage = 0;
const pageSize = 5;
let hasMore = true;
let currentSearch = '';

function setError(text) {
  errorMessage.textContent = text || '';
}

// Метод загрузки корневых комментариев с поиском и пагинацией
async function fetchRootComments(page = 0, append = false, search = '') {
  setError('');
  const offset = page * pageSize;
  let url = `/comments?limit=${pageSize}&offset=${offset}`;
  if (search) {
    url += `&search=${encodeURIComponent(search)}`;
  }
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error('Ошибка загрузки комментариев');
    const data = await response.json();
    if (!Array.isArray(data)) throw new Error('Получены некорректные данные');
    if (append) loadedComments = [...loadedComments, ...data];
    else {
      loadedComments = data;
      commentsList.innerHTML = '';
    }
    renderRootComments();
    hasMore = data.length >= pageSize;
    prevPageBtn.disabled = page === 0;
    nextPageBtn.disabled = !hasMore;
    currentPage = page;
  } catch (err) {
    setError(err.message);
  }
}

// Рендер листа комментариев
function renderRootComments() {
  commentsList.innerHTML = '';
  loadedComments.forEach(comment => {
    commentsList.appendChild(createCommentNode(comment));
  });
}

// Создание DOM узла комментария
function createCommentNode(comment) {
  const li = document.createElement('li');
  li.className = 'comment';
  li.dataset.commentId = comment.id;

  const contentDiv = document.createElement('div');
  contentDiv.className = 'content';
  contentDiv.textContent = `#${comment.id} - ${comment.content}`;
  li.appendChild(contentDiv);

  const actions = document.createElement('span');
  actions.className = 'actions';

  const replyBtn = document.createElement('button');
  replyBtn.textContent = 'Reply';
  replyBtn.onclick = () => {
    replyParentIdField.value = String(comment.id);
    contentField.focus();
    cancelReplyBtn.style.display = 'inline';
  };

  const delBtn = document.createElement('button');
  delBtn.textContent = 'Удалить';
  delBtn.style.marginLeft = '10px';
  delBtn.onclick = async () => {
    if (!confirm(`Удалить комментарий №${comment.id}?`)) return;
    try {
      const res = await fetch(`/comments/${comment.id}`, { method: 'DELETE' });
      if (!res.ok) throw new Error('Ошибка при удалении комментария');
      loadComments();
    } catch (err) {
      setError(err.message);
    }
  };

  actions.appendChild(replyBtn);
  actions.appendChild(delBtn);
  li.appendChild(actions);

  const childrenContainer = document.createElement('ul');
  childrenContainer.className = 'children';
  li.appendChild(childrenContainer);

  const loadRepliesBtn = document.createElement('button');
  loadRepliesBtn.textContent = 'Показать ответы';
  loadRepliesBtn.className = 'load-replies-btn';
  loadRepliesBtn.onclick = () => {
    loadRepliesBtn.disabled = true;
    fetchChildComments(comment.id, childrenContainer, loadRepliesBtn);
  };
  li.appendChild(loadRepliesBtn);

  return li;
}

// Загрузка дочерних комментариев
async function fetchChildComments(parent_id, container, button) {
  setError('');
  try {
    const response = await fetch(`/comments/${parent_id}/children`);
    if (!response.ok) throw new Error('Ошибка загрузки ответов');
    const data = await response.json();
    if (!Array.isArray(data)) throw new Error('Некорректные данные');

    if (data.length === 0) {
      container.innerHTML = '<li>Нет ответов</li>';
      button.style.display = 'none';
      return;
    }

    data.forEach(comment => container.appendChild(createCommentNode(comment)));
    button.style.display = 'none';
  } catch (err) {
    setError(`Ошибка загрузки ответов: ${err.message}`);
    button.disabled = false;
  }
}

// Обработка пагинации
prevPageBtn.onclick = () => {
  if (currentPage > 0) fetchRootComments(currentPage - 1, false, currentSearch);
};
nextPageBtn.onclick = () => {
  if (hasMore) fetchRootComments(currentPage + 1, false, currentSearch);
};

// Очистка parent_id и текста только при отмене ответа
cancelReplyBtn.onclick = () => {
  replyParentIdField.value = '';
  contentField.value = '';
  cancelReplyBtn.style.display = 'none';
};

// Обработка отправки формы
form.onsubmit = async e => {
  e.preventDefault();
  setError('');
  const content = contentField.value.trim();
  if (!content) {
    setError('Content is required');
    return;
  }

  let parentIdValue = replyParentIdField.value.trim();
  let body = { content };

  if (parentIdValue !== '' && !isNaN(Number(parentIdValue))) {
    body.parent_id = Number(parentIdValue);
  } else {
    // Если parent_id пустой или не число, создаем как корневой
    replyParentIdField.value = '';
  }

  try {
    const res = await fetch('/comments', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error('Failed to create comment');
    const data = await res.json();
    alert('Comment created with ID: ' + data['Comment Created']);
    contentField.value = '';
    replyParentIdField.value = '';
    cancelReplyBtn.style.display = 'none';
    fetchRootComments(currentPage, false, currentSearch);
  } catch (err) {
    setError(err.message);
  }
};

// Обработка поиска
searchBtn.onclick = () => {
  loadedComments = [];
  currentPage = 0;
  currentSearch = searchBox.value.trim();
  fetchRootComments(0, false, currentSearch);
};

searchBox.addEventListener('keypress', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    searchBtn.click();
  }
});

// Изначальная загрузка
fetchRootComments();

function loadComments() {
  fetchRootComments(currentPage, false, currentSearch);
}
</script>

</body>
</html>